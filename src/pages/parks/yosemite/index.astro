---
import fs from "node:fs";
import path from "node:path";

import Layout from "../../../layouts/Layout.astro";
import LightboxGallery from "../../../components/LightboxGallery.astro";
import PhotoSwipeInit from "../../../components/PhotoSwipeInit.jsx";
import { getPublicImageSize } from "../../../lib/imageMeta.js";

const park = {
  name: "Yosemite National Park",
  location: "California",
  hero: "/images/parks/yosemite.jpg",
  subtitle: "Granite cliffs, waterfalls, and high-country light.",
  intro: `
Yosemite is one of those places that feels unreal in person — towering granite,
deep valleys, and that constant sense that the landscape is larger than your
camera can capture.
`.trim(),
};

const galleryId = "yosemite-gallery";

/**
 * Auto-discover images in:
 *   public/images/parks/yosemite/gallery/
 */
const galleryDir = path.join(
  process.cwd(),
  "public",
  "images",
  "parks",
  "yosemite",
  "gallery"
);

const photoFiles = fs
  .readdirSync(galleryDir)
  .filter((name) => !name.startsWith("."))
  .filter((name) => /\.(jpe?g|png|webp)$/i.test(name))
  .sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));

/**
 * Build PhotoSwipe metadata (width/height must match display orientation).
 * NOTE: getPublicImageSize is async in the fixed imageMeta.js below.
 */
const photos = await Promise.all(
  photoFiles.map(async (filename) => {
    const src = `/images/parks/yosemite/gallery/${filename}`;
    const { width, height } = await getPublicImageSize(src);

    return {
      src,
      width,
      height,
      title: filename,
      alt: filename,
    };
  })
);
---

<Layout title={park.name}>
  <!-- Park Hero -->
  <section class="park-hero">
    <div
      class="park-hero__image"
      style={`background-image: url('${park.hero}');`}
    ></div>
    <div class="park-hero__overlay"></div>

    <div class="container park-hero__content">
      <p class="park-hero__kicker">{park.location}</p>
      <h1 class="park-hero__title">{park.name}</h1>
      <p class="park-hero__subtitle">{park.subtitle}</p>

      <div class="park-hero__actions">
        <a class="button button--primary" href="#gallery">View Gallery</a>
        <a class="button button--ghost" href="/parks">← All Parks</a>
      </div>
    </div>
  </section>

  <!-- Intro -->
  <section class="park-intro">
    <div class="container">
      <div class="park-intro__card">
        <h2>About this visit</h2>
        <p>{park.intro}</p>
      </div>
    </div>
  </section>

  <!-- Gallery -->
  <section class="park-gallery" id="gallery">
    <div class="container">
      <div class="park-gallery__header">
        <h2>Gallery</h2>
        <p>Click any photo to open a fullscreen viewer with left/right navigation.</p>
      </div>

      <LightboxGallery photos={photos} galleryId={galleryId} />
      <PhotoSwipeInit client:load galleryId={galleryId} />

      <div class="park-gallery__footer">
        <a class="button button--ghost" href="/parks">← Back to All Parks</a>
      </div>
    </div>
  </section>
</Layout>